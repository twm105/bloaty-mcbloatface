{% extends "base.html" %}

{% block title %}Meal History - Bloaty McBloatface{% endblock %}

{% block content %}
<article>
    <header>
        <h1>Meal History</h1>
        <p>View and manage your logged meals.</p>
    </header>

    <section>
        <a href="/meals/log" role="button">+ Log New Meal</a>
    </section>

    <!-- Meals List -->
    <section>
        {% if meals %}
            {% for meal in meals %}
            <article class="meal-card" x-data="{ showDetails: false }">
                <div class="grid">
                    <!-- Meal Image (if available) -->
                    {% if meal.image_path %}
                    <div style="max-width: 200px;">
                        <img
                            src="/{{ meal.image_path }}"
                            alt="Meal"
                            style="width: 100%; height: auto; border-radius: 8px;"
                        >
                    </div>
                    {% endif %}

                    <!-- Meal Info -->
                    <div>
                        <h3 style="margin-top: 0;">
                            {{ meal.timestamp.strftime('%B %d, %Y') }}
                            <small style="font-weight: normal; color: var(--muted-color);">
                                {{ meal.timestamp.strftime('%I:%M %p') }}
                            </small>
                        </h3>

                        {% if meal.country %}
                        <p><small>üìç {{ meal.country }}</small></p>
                        {% endif %}

                        {% if meal.user_notes %}
                        <p><small>{{ meal.user_notes }}</small></p>
                        {% endif %}

                        <!-- Ingredients Summary -->
                        {% if meal.meal_ingredients %}
                        <div style="margin-top: 1rem;">
                            <button
                                @click="showDetails = !showDetails"
                                class="secondary"
                                style="padding: 0.3rem 0.6rem; font-size: 0.85rem;"
                            >
                                <span x-text="showDetails ? '‚ñº' : '‚ñ∂'"></span>
                                {{ meal.meal_ingredients|length }} ingredient(s)
                            </button>

                            <!-- Ingredients List (collapsible) -->
                            <div x-show="showDetails" x-cloak style="margin-top: 0.5rem;">
                                <ul style="margin: 0; padding-left: 1.5rem; font-size: 0.9rem;">
                                    {% for meal_ingredient in meal.meal_ingredients %}
                                    <li>
                                        <strong>{{ meal_ingredient.ingredient.name }}</strong>
                                        ({{ meal_ingredient.state.value }})
                                        {% if meal_ingredient.quantity_description %}
                                        - {{ meal_ingredient.quantity_description }}
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% else %}
                        <p><small><em>No ingredients logged</em></small></p>
                        {% endif %}

                        <!-- Actions -->
                        <div style="margin-top: 1rem;">
                            <a href="/meals/{{ meal.id }}/edit-ingredients" role="button" class="secondary" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;">
                                Edit
                            </a>
                            <button
                                hx-delete="/meals/{{ meal.id }}"
                                hx-confirm="Are you sure you want to delete this meal?"
                                hx-target="closest .meal-card"
                                hx-swap="outerHTML"
                                class="secondary"
                                style="padding: 0.3rem 0.6rem; font-size: 0.85rem;"
                            >
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </article>
            {% endfor %}
        {% else %}
            <article>
                <p><em>No meals logged yet.</em></p>
                <a href="/meals/log" role="button">Log your first meal</a>
            </article>
        {% endif %}
    </section>

    <section>
        <a href="/" role="button" class="secondary">Back to Home</a>
    </section>
</article>
{% endblock %}
