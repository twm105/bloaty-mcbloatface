{% extends "base.html" %}

{% block title %}Meal History - Bloaty McBloatface{% endblock %}

{% block content %}
<div style="margin-bottom: var(--space-6);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6);">
        <div>
            <h1 style="margin-bottom: var(--space-2);">Meal History</h1>
            <p class="text-muted" style="margin: 0;">View and manage your logged meals</p>
        </div>
        <a href="/meals/log" class="btn-primary">
            <svg class="icon icon-sm" aria-hidden="true">
                <use href="/static/icons/lucide-sprite.svg#plus"></use>
            </svg>
            Log New Meal
        </a>
    </div>

    <!-- Meals Grid -->
    {% if meals %}
    <div class="card-grid" x-data="{ expandedMeal: null }">
        {% for meal in meals %}
        <a
            href="/meals/{{ meal.id }}/edit-ingredients"
            class="meal-card"
            style="text-decoration: none; color: inherit; cursor: pointer; position: relative;"
            onclick="if (event.target.closest('.ingredient-toggle') || event.target.closest('.icon-button')) { event.preventDefault(); return false; }"
        >
            <!-- Circular Image -->
            {% if meal.image_path %}
            <div class="meal-card-image-container">
                <img
                    src="/{{ meal.image_path }}"
                    alt="{{ meal.name or 'Meal' }}"
                    class="meal-thumbnail-lg"
                    style="--crop-x: {{ meal.meal_image_crop_x or 50 }}%; --crop-y: {{ meal.meal_image_crop_y or 50 }}%;"
                    loading="lazy"
                >
            </div>
            {% endif %}

            <!-- Meal Name -->
            <h3 class="meal-card-name">{{ meal.name or 'Untitled Meal' }}</h3>

            <!-- Metadata -->
            <div class="meal-card-meta">
                <div>{{ meal.timestamp.strftime('%b %d, %Y') }} â€¢ {{ meal.timestamp.strftime('%I:%M %p') }}</div>
                {% if meal.country %}
                <div style="margin-top: var(--space-1);">
                    <svg class="icon icon-xs" aria-hidden="true" style="vertical-align: text-bottom;">
                        <use href="/static/icons/lucide-sprite.svg#map-pin"></use>
                    </svg>
                    {{ meal.country }}
                </div>
                {% else %}
                <!-- Empty placeholder to maintain vertical spacing -->
                <div style="height: 20px;"></div>
                {% endif %}
            </div>

            <!-- Ingredients (collapsible) -->
            {% if meal.meal_ingredients %}
            <div style="margin-top: var(--space-4);">
                <button
                    type="button"
                    @click.stop="expandedMeal === {{ meal.id }} ? expandedMeal = null : expandedMeal = {{ meal.id }}"
                    class="ingredient-toggle btn-ghost btn-sm"
                    style="width: 100%;"
                >
                    <span>{{ meal.meal_ingredients|length }} ingredient{{ 's' if meal.meal_ingredients|length != 1 else '' }}</span>
                    <svg class="icon icon-xs" aria-hidden="true" :style="expandedMeal === {{ meal.id }} ? 'transform: rotate(180deg)' : ''">
                        <use href="/static/icons/lucide-sprite.svg#chevron-down"></use>
                    </svg>
                </button>

                <!-- Ingredients List -->
                <div x-show="expandedMeal === {{ meal.id }}" x-cloak style="margin-top: var(--space-3);">
                    <div class="badge-group" style="justify-content: center;">
                        {% for meal_ingredient in meal.meal_ingredients %}
                        <span class="ingredient-pill {{ meal_ingredient.state.value }}">
                            {{ meal_ingredient.ingredient.name }}
                        </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% else %}
            <p style="font-size: var(--text-sm); color: var(--color-text-secondary); font-style: italic; text-align: center; margin: var(--space-4) 0;">
                No ingredients logged
            </p>
            {% endif %}

            <!-- Delete button (absolute positioned) -->
            <button
                hx-delete="/meals/{{ meal.id }}"
                hx-target="closest .meal-card"
                hx-swap="outerHTML swap:0.3s"
                hx-confirm="Are you sure you want to delete this meal? This action cannot be undone."
                class="icon-button danger"
                style="position: absolute; top: var(--space-3); right: var(--space-3);"
                onclick="event.preventDefault(); event.stopPropagation();"
                @click.stop
            >
                <svg class="icon icon-xs" aria-hidden="true">
                    <use href="/static/icons/lucide-sprite.svg#trash-2"></use>
                </svg>
            </button>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <div class="card" style="text-align: center; padding: var(--space-12);">
        <svg class="icon icon-lg" aria-hidden="true" style="margin: 0 auto var(--space-4); color: var(--color-text-secondary);">
            <use href="/static/icons/lucide-sprite.svg#image"></use>
        </svg>
        <p style="font-size: var(--text-lg); margin-bottom: var(--space-6);">No meals logged yet</p>
        <a href="/meals/log" class="btn-primary">Log your first meal</a>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div style="margin-top: var(--space-8); text-align: center;">
        <a href="/" class="btn-ghost">
            <svg class="icon icon-sm" aria-hidden="true">
                <use href="/static/icons/lucide-sprite.svg#arrow-left"></use>
            </svg>
            Back to Home
        </a>
    </div>
</div>
{% endblock %}
