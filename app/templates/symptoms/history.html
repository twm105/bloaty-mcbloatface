{% extends "base.html" %}

{% block title %}Symptom History - Bloaty McBloatface{% endblock %}

{% block content %}
<article>
    <header>
        <h1>Symptom History</h1>
        <p>View and manage your logged symptoms.</p>
    </header>

    {% if success %}
    <section>
        <div style="background: #d4edda; border: 1px solid #c3e6cb; padding: 1rem; border-radius: 4px; color: #155724;">
            âœ“ Symptom logged successfully!
        </div>
    </section>
    {% endif %}

    <section>
        <a href="/symptoms/log" role="button">+ Log New Symptom</a>
    </section>

    <!-- Symptoms List -->
    <section>
        {% if symptoms %}
            {% for symptom in symptoms %}
            <article class="symptom-card">
                <header>
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 250px;">
                            <!-- Tags Display (new schema) or Fallback (old schema) -->
                            {% if symptom.tags %}
                                <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    {% for tag in symptom.tags %}
                                    <span style="
                                        display: inline-block;
                                        padding: 0.4rem 0.8rem;
                                        border-radius: 20px;
                                        font-size: 0.9rem;
                                        font-weight: 500;
                                        {% if tag['severity'] >= 7 %}
                                            background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
                                        {% elif tag['severity'] >= 4 %}
                                            background: #fff3cd; color: #856404; border: 1px solid #ffeaa7;
                                        {% else %}
                                            background: #d4edda; color: #155724; border: 1px solid #c3e6cb;
                                        {% endif %}
                                    ">
                                        {{ tag['name'] }} ({{ tag['severity'] }}/10)
                                    </span>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <!-- Old schema fallback -->
                                <h3 style="margin: 0;">
                                    {{ symptom.structured_type or "Symptom" }}
                                    <small style="font-weight: normal;">
                                        - Severity {{ symptom.severity }}/10
                                    </small>
                                </h3>
                            {% endif %}

                            <!-- Time Display -->
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--muted-color);">
                                {% if symptom.start_time %}
                                    <strong>Started:</strong> {{ symptom.start_time.strftime('%b %d, %Y at %I:%M %p') }}
                                    {% if symptom.end_time %}
                                        <br><strong>Ended:</strong> {{ symptom.end_time.strftime('%b %d, %Y at %I:%M %p') }}
                                        {% set duration = (symptom.end_time - symptom.start_time).total_seconds() / 3600 %}
                                        ({{ "%.1f"|format(duration) }} hours)
                                    {% else %}
                                        <br><em>Ongoing or no end time logged</em>
                                    {% endif %}
                                {% else %}
                                    {{ symptom.timestamp.strftime('%B %d, %Y at %I:%M %p') }}
                                {% endif %}
                            </p>

                            <!-- Episode Link -->
                            {% if symptom.episode_id %}
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem;">
                                <span style="background: #e7f3ff; color: #004085; padding: 0.2rem 0.5rem; border-radius: 4px;">
                                    ðŸ”— Part of episode (linked to symptom #{{ symptom.episode_id }})
                                </span>
                            </p>
                            {% endif %}

                            <!-- AI Badge -->
                            {% if symptom.ai_elaborated %}
                            <p style="margin: 0.5rem 0 0 0; font-size: 0.85rem;">
                                <span style="background: #f0f0f0; color: #333; padding: 0.2rem 0.5rem; border-radius: 4px;">
                                    ðŸ¤– AI{% if symptom.user_edited_elaboration %} (edited){% endif %}
                                </span>
                            </p>
                            {% endif %}
                        </div>

                        <!-- Severity Badge (most severe tag or overall) -->
                        <div style="text-align: right;">
                            {% if symptom.tags %}
                                {% set max_severity = symptom.tags | selectattr('severity') | map(attribute='severity') | max %}
                            {% else %}
                                {% set max_severity = symptom.severity %}
                            {% endif %}
                            <span style="
                                display: inline-block;
                                padding: 0.5rem 0.8rem;
                                border-radius: 4px;
                                font-weight: bold;
                                font-size: 1rem;
                                {% if max_severity >= 8 %}
                                    background: #f8d7da; color: #721c24;
                                {% elif max_severity >= 5 %}
                                    background: #fff3cd; color: #856404;
                                {% else %}
                                    background: #d4edda; color: #155724;
                                {% endif %}
                            ">
                                {{ max_severity }}/10
                            </span>
                        </div>
                    </div>
                </header>

                <!-- Notes/Description -->
                <section>
                    {% if symptom.notes %}
                    <p><strong>{% if symptom.ai_elaborated %}AI Description:{% else %}Notes:{% endif %}</strong></p>
                    <p style="margin-left: 1rem;">
                        {{ symptom.notes }}
                    </p>
                    {% elif symptom.raw_description %}
                    <p><strong>Description:</strong></p>
                    <p style="margin-left: 1rem; font-style: italic;">
                        "{{ symptom.raw_description }}"
                    </p>
                    {% endif %}

                    {% if symptom.clarification_history and symptom.clarification_history|length > 0 %}
                    <details style="margin-top: 1rem;">
                        <summary>AI Clarification History</summary>
                        <div style="margin-left: 1rem; margin-top: 0.5rem;">
                            {% for qa in symptom.clarification_history %}
                            <div style="margin-bottom: 0.5rem;">
                                <p style="margin: 0;"><strong>Q:</strong> {{ qa.question }}</p>
                                <p style="margin: 0; margin-left: 1rem;">
                                    <strong>A:</strong>
                                    {% if qa.skipped %}
                                        <em>(skipped)</em>
                                    {% else %}
                                        {{ qa.answer }}
                                    {% endif %}
                                </p>
                            </div>
                            {% endfor %}
                        </div>
                    </details>
                    {% endif %}
                </section>

                <!-- Actions -->
                <footer>
                    <a href="/symptoms/{{ symptom.id }}/edit" role="button" class="secondary" style="padding: 0.3rem 0.6rem; font-size: 0.85rem;">
                        Edit
                    </a>
                    <button
                        hx-delete="/symptoms/{{ symptom.id }}"
                        hx-confirm="Are you sure you want to delete this symptom?"
                        hx-target="closest .symptom-card"
                        hx-swap="outerHTML"
                        class="secondary"
                        style="padding: 0.3rem 0.6rem; font-size: 0.85rem;"
                    >
                        Delete
                    </button>
                </footer>
            </article>
            {% endfor %}
        {% else %}
            <article>
                <p><em>No symptoms logged yet.</em></p>
                <a href="/symptoms/log" role="button">Log your first symptom</a>
            </article>
        {% endif %}
    </section>

    <section>
        <a href="/" role="button" class="secondary">Back to Home</a>
    </section>
</article>
{% endblock %}
