{% extends "base.html" %}

{% block title %}Symptom History - Bloaty McBloatface{% endblock %}

{% block content %}
<div style="margin-bottom: var(--space-6);">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-6);">
        <div>
            <h1 style="margin-bottom: var(--space-2);">Symptom History</h1>
            <p class="text-muted" style="margin: 0;">View and manage your logged symptoms</p>
        </div>
        <a href="/symptoms/log" class="btn-primary">
            <svg class="icon icon-sm" aria-hidden="true">
                <use href="/static/icons/lucide-sprite.svg#plus"></use>
            </svg>
            Log New Symptom
        </a>
    </div>

    {% if success %}
    <div style="background: var(--color-success); color: var(--color-bg-primary); padding: var(--space-4); border-radius: var(--radius-md); margin-bottom: var(--space-6);">
        <svg class="icon icon-xs" aria-hidden="true" style="vertical-align: text-bottom;">
            <use href="/static/icons/lucide-sprite.svg#check"></use>
        </svg>
        Symptom logged successfully!
    </div>
    {% endif %}

    <!-- Symptoms Grid -->
    {% if symptoms %}
    <div class="card-grid">
        {% for symptom in symptoms %}
        <a
            href="/symptoms/{{ symptom.id }}/edit"
            class="meal-card"
            style="text-decoration: none; color: inherit; cursor: pointer; position: relative; padding: var(--space-5);"
            @click="if ($event.target.closest('.icon-button')) $event.preventDefault()"
        >
            <!-- Date and Time (TOP) -->
            <div style="
                margin-bottom: var(--space-3);
                font-size: var(--text-sm);
                color: var(--color-text-secondary);
            ">
                {% if symptom.start_time %}
                <div style="font-weight: var(--font-medium); color: var(--color-text-primary);">
                    {{ symptom.start_time.strftime('%b %d, %Y • %I:%M %p') }}
                </div>
                {% else %}
                <div style="font-weight: var(--font-medium); color: var(--color-text-primary);">
                    {{ symptom.timestamp.strftime('%b %d, %Y • %I:%M %p') }}
                </div>
                {% endif %}
            </div>

            <!-- Ongoing Note (if applicable) -->
            {% if symptom.start_time and not symptom.end_timestamp %}
            <div style="margin-bottom: var(--space-3); font-size: var(--text-sm); color: var(--color-text-tertiary); font-style: italic;">
                Ongoing or no end time logged
            </div>
            {% elif symptom.end_timestamp %}
            <div style="margin-bottom: var(--space-3); font-size: var(--text-sm); color: var(--color-text-secondary);">
                Ended: {{ symptom.end_timestamp.strftime('%I:%M %p') }}
                <span style="color: var(--color-text-tertiary);">
                    ({{ ((symptom.end_timestamp - symptom.start_time).total_seconds() / 3600) | round(1) }}h duration)
                </span>
            </div>
            {% endif %}

            <!-- Symptom Tags (max 2 visible, show +N) -->
            {% if symptom.tags %}
            <div style="display: flex; flex-wrap: wrap; gap: var(--space-2);">
                {% set visible_tags = symptom.tags[:2] %}
                {% set hidden_count = symptom.tags|length - 2 %}

                {% for tag in visible_tags %}
                <span class="severity-pill {% if tag['severity'] >= 7 %}severity-high{% elif tag['severity'] >= 4 %}severity-medium{% else %}severity-low{% endif %}">
                    {{ tag['name'] }}
                </span>
                {% endfor %}

                {% if hidden_count > 0 %}
                <span class="severity-pill" style="background: var(--color-bg-secondary); color: var(--color-text-secondary); border: 1px solid rgba(255, 255, 255, 0.1);">
                    +{{ hidden_count }}
                </span>
                {% endif %}
            </div>
            {% endif %}

            <!-- Delete button (absolute positioned) -->
            <button
                hx-delete="/symptoms/{{ symptom.id }}"
                hx-confirm="Are you sure you want to delete this symptom log?"
                hx-target="closest .meal-card"
                hx-swap="outerHTML"
                class="icon-button danger"
                style="position: absolute; top: var(--space-3); right: var(--space-3);"
                onclick="event.preventDefault(); event.stopPropagation();"
                @click.stop
            >
                <svg width="12" height="12" viewBox="0 0 24 24" class="icon icon-xxs" aria-hidden="true" style="stroke-width: 1.5;">
                    <use href="/static/icons/lucide-sprite.svg#trash-2"></use>
                </svg>
            </button>
        </a>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div style="text-align: center; padding: var(--space-12) var(--space-6); color: var(--color-text-secondary);">
        <svg class="icon icon-lg" aria-hidden="true" style="margin-bottom: var(--space-4); color: var(--color-accent-green);">
            <use href="/static/icons/lucide-sprite.svg#list"></use>
        </svg>
        <p style="margin-bottom: var(--space-4); font-size: var(--text-lg);">No symptoms logged yet</p>
        <a href="/symptoms/log" class="btn-primary">Log Your First Symptom</a>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div style="margin-top: var(--space-8); text-align: center;">
        <a href="/" class="btn-ghost">
            <svg class="icon icon-sm" aria-hidden="true">
                <use href="/static/icons/lucide-sprite.svg#arrow-left"></use>
            </svg>
            Back to Home
        </a>
    </div>
</div>
{% endblock %}
