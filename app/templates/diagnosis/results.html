{% extends "base.html" %}

{% block title %}Diagnosis Results{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-title">Food Trigger Diagnosis</h1>
    <p class="page-description">
        Analysis of {{ diagnosis_run.meals_analyzed }} meals and {{ diagnosis_run.symptoms_analyzed }} symptoms
        from {{ diagnosis_run.date_range_start.strftime('%b %d, %Y') }} to {{ diagnosis_run.date_range_end.strftime('%b %d, %Y') }}
    </p>
</div>

<!-- Medical Disclaimer -->
<div class="disclaimer disclaimer-warning" style="margin-bottom: var(--space-6);">
    <svg class="disclaimer-icon icon icon-sm" aria-hidden="true">
        <use href="/static/icons/lucide-sprite.svg#alert-triangle"></use>
    </svg>
    <div class="disclaimer-content">
        <div class="disclaimer-title">Important Medical Disclaimer</div>
        <div class="disclaimer-text">
            This analysis identifies correlations in your personal data and does NOT constitute medical advice or diagnosis. Correlation does not prove causation. Multiple factors may influence your symptoms. Please consult with a qualified healthcare professional before making any dietary changes or health decisions.
        </div>
    </div>
</div>

<!-- Action section - only show when run is completed (not processing) -->
{% if run_status == "completed" %}
<div style="margin-bottom: var(--space-6);">
    {% if has_new_data %}
    <!-- Show Run Analysis button -->
    <div style="display: flex; gap: var(--space-4);" x-data="{ isAnalyzing: false }">
        <button
            class="btn btn-primary"
            hx-post="/diagnosis/analyze"
            hx-ext="json-enc"
            hx-vals='{"async_mode": true}'
            hx-trigger="click"
            hx-swap="none"
            @click="isAnalyzing = true"
            :disabled="isAnalyzing"
            @htmx:after-request="
                if ($event.detail.successful) {
                    window.location.reload();
                } else {
                    isAnalyzing = false;
                    alert('Analysis failed. Please try again.');
                }
            "
        >
            <span x-show="!isAnalyzing">Run New Analysis</span>
            <span x-show="isAnalyzing" style="display: flex; align-items: center; gap: 0.5rem;">
                <div class="spinner-small"></div>
                Starting...
            </span>
        </button>
        <a href="/diagnosis/methodology" class="btn btn-secondary">How This Works</a>
    </div>
    {% else %}
    <!-- Show no new data message -->
    <div class="ai-analyzing-banner" style="background: rgba(107, 114, 128, 0.1); border-left-color: #6B7280; color: #9CA3AF;">
        <svg width="16" height="16" viewBox="0 0 24 24" class="icon icon-sm" style="flex-shrink: 0; overflow: visible;">
            <use href="/static/icons/lucide-sprite.svg#info"></use>
        </svg>
        <div>
            <span>No new data to analyze.</span>
            <span style="display: block; font-size: var(--text-xs); margin-top: 2px;">
                Log more meals and symptoms to generate new analysis.
            </span>
        </div>
    </div>
    <a href="/diagnosis/methodology" class="btn btn-secondary" style="margin-top: var(--space-4);">How This Works</a>
    {% endif %}
</div>
{% endif %}

<!-- Main diagnosis results container -->
<div x-data="diagnosisResults()" x-init="initSSE()" data-run-id="{{ run_id }}" data-run-status="{{ run_status }}">

    <!-- Progress spinner (shown during processing) - matches meal analysis style -->
    <div x-show="isProcessing" x-cloak class="ai-analyzing-banner" style="margin-bottom: var(--space-6);">
        <div class="spinner-small"></div>
        <div>
            <span>Analyzing ingredient <span x-text="completed"></span> of <span x-text="total"></span>...</span>
            <span x-show="currentIngredient" class="analyzing-ingredient" x-text="currentIngredient" style="display: block; font-size: var(--text-xs); margin-top: 2px;"></span>
        </div>
    </div>

    <!-- Error message -->
    <div x-show="errorMessage" x-cloak class="disclaimer disclaimer-error" style="margin-bottom: var(--space-6);">
        <svg class="disclaimer-icon icon icon-sm" aria-hidden="true">
            <use href="/static/icons/lucide-sprite.svg#alert-circle"></use>
        </svg>
        <div class="disclaimer-content">
            <div class="disclaimer-title">Analysis Error</div>
            <div class="disclaimer-text" x-text="errorMessage"></div>
        </div>
    </div>

    <!-- Results Grid -->
    <div style="display: grid; gap: var(--space-6);">
        <!-- Initial results from server (if any) -->
        {% for result in results %}
        <div class="diagnosis-card" data-result-id="{{ result.id }}" x-data="{ expanded: false }">
            <div class="diagnosis-card-header" @click="expanded = !expanded">
                <div class="diagnosis-card-summary">
                    <svg class="chevron-icon icon icon-sm" :class="{ 'rotated': expanded }" aria-hidden="true">
                        <use href="/static/icons/lucide-sprite.svg#chevron-down"></use>
                    </svg>
                    <span class="ingredient-name">{{ result.ingredient.normalized_name.replace('_', ' ') }}</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" class="arrow-icon icon icon-xxs" aria-hidden="true" style="stroke-width: 1.5;">
                        <use href="/static/icons/lucide-sprite.svg#arrow-right"></use>
                    </svg>
                    <span class="symptom-summary">
                        {% for symptom in result.associated_symptoms[:2] %}{{ symptom.name }}{% if not loop.last %}, {% endif %}{% endfor %}{% if result.associated_symptoms|length > 2 %} +{{ result.associated_symptoms|length - 2 }} more{% endif %}
                    </span>
                </div>
                <div class="diagnosis-card-actions">
                    <span class="confidence-badge confidence-{{ result.confidence_level }}">
                        {{ result.confidence_level|capitalize }}
                    </span>
                    <button
                        class="icon-button danger"
                        @click.stop="deleteResult({{ result.id }})"
                        title="Delete result"
                    >
                        <svg width="12" height="12" viewBox="0 0 24 24" class="icon icon-xxs" aria-hidden="true" style="stroke-width: 1.5;">
                            <use href="/static/icons/lucide-sprite.svg#trash-2"></use>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="diagnosis-card-body" x-show="expanded" x-collapse x-cloak>
                <!-- Diagnosis Summary -->
                <div class="diagnosis-section">
                    <h4 class="section-title">Diagnosis</h4>
                    <p class="section-content">{{ result.diagnosis_summary or result.ai_analysis[:300] if result.ai_analysis else 'No diagnosis summary available.' }}</p>
                </div>

                <!-- Recommendations -->
                <div class="diagnosis-section">
                    <h4 class="section-title">Recommendations</h4>
                    <p class="section-content">{{ result.recommendations_summary or 'No recommendations available.' }}</p>

                    {% if result.processing_suggestions %}
                    <ul class="recommendations-list">
                        {% if result.processing_suggestions.cooked_vs_raw %}
                        <li>{{ result.processing_suggestions.cooked_vs_raw }}</li>
                        {% endif %}
                        {% if result.processing_suggestions.alternatives %}
                        <li>Try alternatives: {{ result.processing_suggestions.alternatives|join(', ') }}</li>
                        {% endif %}
                    </ul>
                    {% endif %}

                    {% if result.alternative_meals %}
                    <div style="margin-top: var(--space-sm);">
                        <span class="text-secondary text-sm">Alternative meals from your history:</span>
                        <ul class="recommendations-list">
                            {% for meal in result.alternative_meals %}
                            <li><strong>{{ meal.name }}</strong> - {{ meal.reason }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>

                <!-- Statistics -->
                <div class="diagnosis-section">
                    <h4 class="section-title">Statistics</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value">{{ result.times_followed_by_symptoms }}/{{ result.times_eaten }}</span>
                            <span class="stat-label">Symptom rate</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ result.immediate_correlation }}</span>
                            <span class="stat-label">0-2hr</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ result.delayed_correlation }}</span>
                            <span class="stat-label">4-24hr</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value">{{ result.cumulative_correlation }}</span>
                            <span class="stat-label">24hr+</span>
                        </div>
                    </div>
                </div>

                <!-- Associated Symptoms -->
                <div class="diagnosis-section">
                    <h4 class="section-title">Associated Symptoms</h4>
                    <ul class="symptoms-list">
                        {% for symptom in result.associated_symptoms %}
                        <li>
                            <span class="symptom-name">{{ symptom.name.title() }}</span>
                            <span class="symptom-details">
                                {{ symptom.frequency }}x, {{ symptom.lag_hours|round(1) }}hr lag, severity {{ symptom.severity_avg|round(1) }}/10
                            </span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>

                <!-- Citations -->
                {% if result.citations %}
                <div class="diagnosis-section">
                    <h4 class="section-title">Sources</h4>
                    <div class="citations-list">
                        {% for citation in result.citations %}
                        <a href="{{ citation.source_url }}"
                           target="_blank"
                           rel="noopener noreferrer"
                           class="citation-link"
                           data-tippy-content="{{ citation.snippet }}"
                           x-init="tippy($el, { theme: 'light', placement: 'top', maxWidth: 300 })">
                            <span class="citation-title">{{ citation.source_title }}</span>
                            <span class="badge badge-secondary">{{ citation.source_type }}</span>
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}

                <!-- User Feedback -->
                {% set entity_type = 'diagnosis' %}
                {% set entity_id = result.id %}
                {% set endpoint_url = '/diagnosis/feedback' %}
                {% set result_feedback = feedback_by_result.get(result.id) %}
                {% set existing_rating = result_feedback.rating if result_feedback else 0 %}
                {% set existing_feedback = result_feedback.feedback_text if result_feedback and result_feedback.feedback_text else '' %}
                {% include 'components/_feedback_rating.html' %}
            </div>
        </div>
        {% endfor %}

        <!-- Dynamically added results from SSE -->
        <template x-for="result in sseResults" :key="result.id">
            <div class="diagnosis-card" :data-result-id="result.id" x-data="{ expanded: false }">
                <div class="diagnosis-card-header" @click="expanded = !expanded">
                    <div class="diagnosis-card-summary">
                        <svg class="chevron-icon icon icon-sm" :class="{ 'rotated': expanded }" aria-hidden="true">
                            <use href="/static/icons/lucide-sprite.svg#chevron-down"></use>
                        </svg>
                        <span class="ingredient-name" x-text="formatIngredientName(result.ingredient_name)"></span>
                        <svg width="12" height="12" viewBox="0 0 24 24" class="arrow-icon icon icon-xxs" aria-hidden="true" style="stroke-width: 1.5;">
                            <use href="/static/icons/lucide-sprite.svg#arrow-right"></use>
                        </svg>
                        <span class="symptom-summary" x-text="formatSymptoms(result.associated_symptoms)"></span>
                    </div>
                    <div class="diagnosis-card-actions">
                        <span class="confidence-badge" :class="'confidence-' + result.confidence_level">
                            <span x-text="result.confidence_level.charAt(0).toUpperCase() + result.confidence_level.slice(1)"></span>
                        </span>
                        <button
                            class="icon-button danger"
                            @click.stop="deleteResult(result.id)"
                            title="Delete result"
                        >
                            <svg width="12" height="12" viewBox="0 0 24 24" class="icon icon-xxs" aria-hidden="true" style="stroke-width: 1.5;">
                                <use href="/static/icons/lucide-sprite.svg#trash-2"></use>
                            </svg>
                        </button>
                    </div>
                </div>

                <div class="diagnosis-card-body" x-show="expanded" x-collapse x-cloak>
                    <div class="diagnosis-section">
                        <h4 class="section-title">Diagnosis</h4>
                        <p class="section-content" x-text="result.diagnosis_summary || 'No diagnosis summary available.'"></p>
                    </div>

                    <div class="diagnosis-section">
                        <h4 class="section-title">Recommendations</h4>
                        <p class="section-content" x-text="result.recommendations_summary || 'No recommendations available.'"></p>
                        <ul class="recommendations-list" x-show="result.processing_suggestions">
                            <li x-show="result.processing_suggestions?.cooked_vs_raw" x-text="result.processing_suggestions?.cooked_vs_raw"></li>
                            <li x-show="result.processing_suggestions?.alternatives?.length">
                                Try alternatives: <span x-text="result.processing_suggestions?.alternatives?.join(', ')"></span>
                            </li>
                        </ul>
                    </div>

                    <div class="diagnosis-section">
                        <h4 class="section-title">Statistics</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <span class="stat-value" x-text="result.times_followed_by_symptoms + '/' + result.times_eaten"></span>
                                <span class="stat-label">Symptom rate</span>
                            </div>
                        </div>
                    </div>

                    <div class="diagnosis-section" x-show="result.citations?.length">
                        <h4 class="section-title">Sources</h4>
                        <div class="citations-list">
                            <template x-for="citation in result.citations" :key="citation.url">
                                <a :href="citation.url"
                                   target="_blank"
                                   rel="noopener noreferrer"
                                   class="citation-link"
                                   :data-tippy-content="citation.snippet"
                                   x-init="tippy($el, { theme: 'light', placement: 'top', maxWidth: 300 })">
                                    <span class="citation-title" x-text="citation.title"></span>
                                    <span class="badge badge-secondary" x-text="citation.source_type"></span>
                                </a>
                            </template>
                        </div>
                    </div>

                    <!-- User Feedback (SSE-rendered) -->
                    <div class="diagnosis-section feedback-section"
                         x-data="feedbackRating({
                             entityType: 'diagnosis',
                             entityId: result.id,
                             endpoint: '/diagnosis/feedback',
                             idField: 'result_id',
                             existingRating: 0,
                             existingFeedback: ''
                         })">
                        <h4 class="section-title">Rate this Diagnosis</h4>

                        <div class="rating-stars">
                            <template x-for="i in [1,2,3,4,5]" :key="i">
                                <button
                                    @click="submitRating(i)"
                                    class="star-btn"
                                    :class="{ 'active': rating >= i }"
                                >
                                    <svg width="20" height="20" viewBox="0 0 24 24" class="icon icon-sm" aria-hidden="true" style="overflow: visible;">
                                        <use href="/static/icons/lucide-sprite.svg#star"></use>
                                    </svg>
                                </button>
                            </template>
                            <span x-show="submitting" class="rating-saving">
                                <span class="spinner-tiny"></span>
                            </span>
                            <span x-show="hasRated && !submitting" class="rating-saved" x-cloak>
                                <svg width="14" height="14" viewBox="0 0 24 24" class="icon icon-xs" aria-hidden="true" style="color: var(--color-accent-green); overflow: visible;">
                                    <use href="/static/icons/lucide-sprite.svg#check"></use>
                                </svg>
                            </span>
                        </div>

                        <div x-show="hasRated" x-collapse x-cloak class="feedback-form">
                            <textarea
                                x-model="feedback"
                                placeholder="Optional: Share your thoughts..."
                                class="feedback-textarea"
                            ></textarea>
                            <button
                                @click="submitComment()"
                                :disabled="!feedback.trim() || commentSubmitting || !commentDirty"
                                class="btn btn-sm"
                                :class="commentDirty ? 'btn-primary' : 'btn-secondary'"
                            >
                                <span x-show="commentSubmitting" class="spinner-tiny" style="margin-right: 0.5rem;"></span>
                                <span x-text="commentButtonText"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>
    </div>

    <!-- Empty state (only shown when no server results AND no SSE results) -->
    {% if not results %}
    <div x-show="!isProcessing && !errorMessage && sseResults.length === 0" x-cloak class="card">
        <div class="card-content">
            <p class="text-secondary">No potential trigger ingredients identified in this analysis period. Try expanding the date range or continue logging meals and symptoms.</p>
        </div>
    </div>
    {% endif %}

<!-- Discounted Ingredients Section -->
<!-- Discarded ingredients section - shown when server-rendered OR SSE items exist -->
<details class="discarded-section" style="margin-top: var(--space-6);"
         x-show="{{ discounted|length }} > 0 || sseDiscounted.length > 0" x-cloak>
    <summary class="discarded-summary">
        <svg width="16" height="16" viewBox="0 0 24 24" class="icon icon-sm" style="overflow: visible;">
            <use href="/static/icons/lucide-sprite.svg#eye-off"></use>
        </svg>
        <span>Discarded Ingredients (<span x-text="{{ discounted|length }} + sseDiscounted.length"></span>)</span>
        <svg width="12" height="12" viewBox="0 0 24 24" class="chevron-icon icon icon-sm" style="overflow: visible; margin-left: auto;">
            <use href="/static/icons/lucide-sprite.svg#chevron-down"></use>
        </svg>
    </summary>

    <div class="discarded-content">
        <p class="discarded-explainer">
            These ingredients showed statistical correlation but were likely confounded by other trigger ingredients.
            They have been excluded from the main results to avoid false positives.
        </p>

        <div class="discarded-list">
            <!-- Server-rendered discounted items -->
            {% for di in discounted %}
            <details class="discarded-card">
                <summary class="discarded-card-summary">
                    <span class="ingredient-name">{{ di.ingredient.normalized_name.replace('_', ' ') }}</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" class="arrow-icon icon icon-xxs" aria-hidden="true" style="stroke-width: 1.5; overflow: visible;">
                        <use href="/static/icons/lucide-sprite.svg#arrow-right"></use>
                    </svg>
                    <span class="confounded-by">{{ di.confounded_by.normalized_name.replace('_', ' ') if di.confounded_by else 'medically unlikely' }}</span>
                    <span class="badge confidence-discarded">Discarded</span>
                </summary>

                <div class="discarded-card-body">
                    <!-- Primary justification -->
                    <div class="diagnosis-section">
                        <h4 class="section-title">Why Discarded</h4>
                        <p class="section-content">{{ di.discard_justification }}</p>
                    </div>

                    <!-- Original analysis data (nested collapsible) -->
                    <details class="original-analysis">
                        <summary class="original-analysis-summary">
                            <svg width="14" height="14" viewBox="0 0 24 24" class="icon icon-xs" style="overflow: visible;">
                                <use href="/static/icons/lucide-sprite.svg#file-text"></use>
                            </svg>
                            View original analysis data
                        </summary>

                        <div class="original-analysis-content">
                            <!-- Correlation stats -->
                            <div class="analysis-section">
                                <h5 class="subsection-title">Correlation Analysis</h5>
                                <ul class="analysis-list">
                                    <li>Confidence: {{ di.original_confidence_level|capitalize if di.original_confidence_level else 'N/A' }}</li>
                                    <li>Eaten {{ di.times_eaten or 0 }} times, symptoms followed {{ di.times_followed_by_symptoms or 0 }} times</li>
                                    <li>Timing: {{ di.immediate_correlation or 0 }} immediate, {{ di.delayed_correlation or 0 }} delayed, {{ di.cumulative_correlation or 0 }} cumulative</li>
                                </ul>
                                {% if di.associated_symptoms %}
                                <p class="symptoms-text">Symptoms: {% for s in di.associated_symptoms %}{{ s.name }} ({{ s.frequency }}x){% if not loop.last %}, {% endif %}{% endfor %}</p>
                                {% endif %}
                            </div>

                            <!-- Co-occurrence stats -->
                            {% if di.confounded_by %}
                            <div class="analysis-section">
                                <h5 class="subsection-title">Co-occurrence with {{ di.confounded_by.normalized_name.replace('_', ' ') }}</h5>
                                <ul class="analysis-list">
                                    <li>P({{ di.ingredient.normalized_name.replace('_', ' ') }} | {{ di.confounded_by.normalized_name.replace('_', ' ') }}) = {{ (di.conditional_probability * 100)|round|int if di.conditional_probability else 0 }}%</li>
                                    <li>Lift: {{ di.lift|round(1) if di.lift else 0 }}x</li>
                                    <li>Appeared together in {{ di.cooccurrence_meals_count or 0 }} meals</li>
                                </ul>
                            </div>
                            {% endif %}

                            <!-- Medical grounding -->
                            {% if di.medical_grounding_summary %}
                            <div class="analysis-section">
                                <h5 class="subsection-title">Medical Context</h5>
                                <p class="section-content">{{ di.medical_grounding_summary }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </details>
                </div>
            </details>
            {% endfor %}

            <!-- Dynamically added discounted items from SSE -->
            <template x-for="di in sseDiscounted" :key="di.id">
                <details class="discarded-card">
                    <summary class="discarded-card-summary">
                        <span class="ingredient-name" x-text="formatIngredientName(di.ingredient_name)"></span>
                        <svg width="12" height="12" viewBox="0 0 24 24" class="arrow-icon icon icon-xxs" aria-hidden="true" style="stroke-width: 1.5; overflow: visible;">
                            <use href="/static/icons/lucide-sprite.svg#arrow-right"></use>
                        </svg>
                        <span class="confounded-by" x-text="di.confounded_by_name || 'medically unlikely'"></span>
                        <span class="badge confidence-discarded">Discarded</span>
                    </summary>

                    <div class="discarded-card-body">
                        <!-- Primary justification -->
                        <div class="diagnosis-section">
                            <h4 class="section-title">Why Discarded</h4>
                            <p class="section-content" x-text="di.discard_justification"></p>
                        </div>

                        <!-- Original analysis data (nested collapsible) -->
                        <details class="original-analysis">
                            <summary class="original-analysis-summary">
                                <svg width="14" height="14" viewBox="0 0 24 24" class="icon icon-xs" style="overflow: visible;">
                                    <use href="/static/icons/lucide-sprite.svg#file-text"></use>
                                </svg>
                                View original analysis data
                            </summary>

                            <div class="original-analysis-content">
                                <!-- Correlation stats -->
                                <div class="analysis-section">
                                    <h5 class="subsection-title">Correlation Analysis</h5>
                                    <ul class="analysis-list">
                                        <li>Confidence: <span x-text="di.original_confidence_level ? di.original_confidence_level.charAt(0).toUpperCase() + di.original_confidence_level.slice(1) : 'N/A'"></span></li>
                                        <li>Eaten <span x-text="di.times_eaten || 0"></span> times, symptoms followed <span x-text="di.times_followed_by_symptoms || 0"></span> times</li>
                                    </ul>
                                </div>

                                <!-- Medical grounding -->
                                <template x-if="di.medical_grounding_summary">
                                    <div class="analysis-section">
                                        <h5 class="subsection-title">Medical Context</h5>
                                        <p class="section-content" x-text="di.medical_grounding_summary"></p>
                                    </div>
                                </template>
                            </div>
                        </details>
                    </div>
                </details>
            </template>
        </div>
    </div>
</details>

</div> <!-- Close x-data="diagnosisResults()" scope -->

<script>
function diagnosisResults() {
    return {
        isProcessing: false,
        completed: 0,
        total: 0,
        currentIngredient: '',
        sseResults: [],
        sseDiscounted: [],
        errorMessage: '',
        eventSource: null,

        initSSE() {
            const runId = this.$el.dataset.runId;
            const runStatus = this.$el.dataset.runStatus;

            if (!runId) return;

            // Only connect SSE if run is still processing
            if (runStatus === 'processing' || runStatus === 'pending') {
                this.isProcessing = true;
                this.connectSSE(runId);
            }
        },

        connectSSE(runId) {
            this.eventSource = new EventSource(`/diagnosis/stream/${runId}`);

            this.eventSource.addEventListener('progress', (e) => {
                const data = JSON.parse(e.data);
                this.completed = data.completed;
                this.total = data.total;
                this.currentIngredient = data.ingredient;
            });

            this.eventSource.addEventListener('result', (e) => {
                const result = JSON.parse(e.data);
                this.sseResults.push(result);
            });

            this.eventSource.addEventListener('discounted', (e) => {
                const discounted = JSON.parse(e.data);
                this.sseDiscounted.push(discounted);
            });

            this.eventSource.addEventListener('complete', (e) => {
                this.isProcessing = false;
                this.eventSource.close();
            });

            this.eventSource.addEventListener('error', (e) => {
                if (e.data) {
                    const data = JSON.parse(e.data);
                    this.errorMessage = data.message;
                }
                this.isProcessing = false;
                this.eventSource.close();
            });

            this.eventSource.onerror = () => {
                this.isProcessing = false;
                this.eventSource.close();
            };
        },

        formatIngredientName(name) {
            if (!name) return '';
            return name.replace(/_/g, ' ');
        },

        formatSymptoms(symptoms) {
            if (!symptoms || symptoms.length === 0) return 'No symptoms';
            const names = symptoms.slice(0, 2).map(s => s.name);
            if (symptoms.length > 2) {
                names.push(`+${symptoms.length - 2} more`);
            }
            return names.join(', ');
        },

        async deleteResult(resultId) {
            if (!confirm('Delete this result?')) return;
            try {
                await fetch(`/diagnosis/results/${resultId}`, { method: 'DELETE' });
                // Remove from SSE results
                this.sseResults = this.sseResults.filter(r => r.id !== resultId);
                // Remove from DOM (for server-rendered results)
                const card = document.querySelector(`[data-result-id="${resultId}"]`);
                if (card) card.remove();
            } catch (err) {
                alert('Failed to delete result');
            }
        },

        async submitFeedback(resultId, rating, feedback) {
            await fetch('/diagnosis/feedback', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    result_id: resultId,
                    rating: rating,
                    feedback_text: feedback
                })
            });
        }
    };
}

// Reusable feedback rating component (unified API)
function feedbackRating(config) {
    return {
        featureType: config.featureType || 'diagnosis_result',
        featureId: config.featureId,
        endpoint: config.endpoint || '/feedback',
        rating: config.existingRating || 0,
        feedback: config.existingFeedback || '',
        savedFeedback: config.existingFeedback || '',  // Track last saved comment
        hasRated: config.existingRating > 0,
        submitting: false,
        commentSubmitting: false,

        // Check if comment has unsaved changes
        get commentDirty() {
            return this.feedback.trim() !== this.savedFeedback.trim();
        },

        // Button text based on state
        get commentButtonText() {
            if (this.savedFeedback) {
                return this.commentDirty ? 'Update Comment' : 'Comment Saved';
            }
            return 'Add Comment';
        },

        async submitRating(stars) {
            this.rating = stars;
            this.submitting = true;

            try {
                // Use FormData for unified endpoint
                const formData = new FormData();
                formData.append('feature_type', this.featureType);
                formData.append('feature_id', this.featureId);
                formData.append('rating', stars);
                if (this.savedFeedback) {
                    formData.append('feedback_text', this.savedFeedback);
                }

                await fetch(this.endpoint, {
                    method: 'POST',
                    body: formData
                });

                this.hasRated = true;
            } catch (err) {
                console.error('Failed to submit rating:', err);
            } finally {
                this.submitting = false;
            }
        },

        async submitComment() {
            if (!this.feedback.trim() || !this.commentDirty) return;

            this.commentSubmitting = true;

            try {
                // Use FormData for unified endpoint
                const formData = new FormData();
                formData.append('feature_type', this.featureType);
                formData.append('feature_id', this.featureId);
                formData.append('rating', this.rating);
                formData.append('feedback_text', this.feedback);

                await fetch(this.endpoint, {
                    method: 'POST',
                    body: formData
                });

                this.savedFeedback = this.feedback;  // Update saved state
            } catch (err) {
                console.error('Failed to submit comment:', err);
            } finally {
                this.commentSubmitting = false;
            }
        }
    };
}
</script>

<style>
/* AI Analyzing Banner - matches meal analysis style */
.ai-analyzing-banner {
    background: #e3f2fd;
    border-left: 4px solid #2196F3;
    color: #1565C0;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.ai-analyzing-banner .analyzing-ingredient {
    opacity: 0.8;
}

/* Diagnosis Card Styles */
.diagnosis-card {
    background: var(--color-bg-secondary);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-md);
    overflow: visible;
    transition: all var(--transition-base);
}

.diagnosis-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4);
    cursor: pointer;
    transition: background-color var(--transition-base);
}

.diagnosis-card-header:hover {
    background-color: rgba(255, 255, 255, 0.03);
}

.diagnosis-card-summary {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex: 1;
    min-width: 0;
}

.ingredient-name {
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
}

.arrow-icon {
    color: var(--color-text-tertiary);
    flex-shrink: 0;
    overflow: visible;
}

.symptom-summary {
    color: var(--color-text-secondary);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.diagnosis-card-actions {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.confidence-badge {
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: white;
}

.confidence-high { background-color: #52B788; }
.confidence-medium { background-color: #D4734B; }
.confidence-low { background-color: #E63946; }
.confidence-insufficient_data { background-color: #6c757d; }

.chevron-icon {
    color: var(--color-text-secondary);
    transition: transform var(--transition-base);
    flex-shrink: 0;
}

.chevron-icon.rotated {
    transform: rotate(180deg);
}

.diagnosis-card-body {
    padding: var(--space-4);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.diagnosis-section {
    margin-bottom: var(--space-4);
}

.diagnosis-section:last-child {
    margin-bottom: 0;
}

.section-title {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
}

.section-content {
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    line-height: 1.6;
    margin: 0;
}

.stats-grid {
    display: flex;
    gap: var(--space-4);
    flex-wrap: wrap;
}

.stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-2) var(--space-3);
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--radius-sm);
}

.stat-value {
    font-weight: var(--font-semibold);
    color: var(--color-text-primary);
}

.stat-label {
    font-size: var(--text-xs);
    color: var(--color-text-tertiary);
}

.symptoms-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.symptoms-list li {
    display: flex;
    justify-content: space-between;
    padding: var(--space-2) 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
}

.symptoms-list li:last-child {
    border-bottom: none;
}

.symptom-name {
    color: var(--color-text-primary);
}

.symptom-details {
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
}

.recommendations-list {
    list-style: disc;
    padding-left: var(--space-4);
    margin: var(--space-2) 0 0 0;
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
}

.citations-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.citation-link {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    color: var(--color-accent-green);
    text-decoration: none;
    font-size: var(--text-sm);
}

.citation-link:hover {
    text-decoration: underline;
}

.citation-title {
    flex: 1;
    min-width: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.feedback-section {
    padding-top: var(--space-4);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.rating-stars {
    display: flex;
    gap: var(--space-1);
    margin-bottom: var(--space-2);
}

.star-btn {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--color-text-tertiary);
    padding: 0;
}

.star-btn.active {
    color: #FFD700;
}

.star-btn:hover {
    color: #FFD700;
}

.feedback-textarea {
    width: 100%;
    min-height: 60px;
    padding: var(--space-2);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: var(--radius-sm);
    background-color: var(--color-bg-primary);
    color: var(--color-text-primary);
    font-family: inherit;
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
    resize: vertical;
}

.feedback-form {
    margin-top: var(--space-3);
}

.rating-saving,
.rating-saved {
    display: inline-flex;
    align-items: center;
    margin-left: var(--space-2);
}

.spinner-tiny {
    width: 12px;
    height: 12px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-top-color: var(--color-accent-green);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    display: inline-block;
}

/* Spinner styles - matches meal analysis */
.spinner-small {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(33, 150, 243, 0.3);
    border-top-color: #2196F3;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    flex-shrink: 0;
}

/* Spinner inside button - white variant */
.btn .spinner-small,
button .spinner-small {
    border-color: rgba(255, 255, 255, 0.3);
    border-top-color: white;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

/* Error disclaimer */
.disclaimer-error {
    background-color: rgba(230, 57, 70, 0.1);
    border-left: 3px solid #E63946;
}

/* Discarded Ingredients Section */
.discarded-section {
    background: var(--color-bg-secondary);
    border: 1px solid rgba(255, 255, 255, 0.05);
    border-radius: var(--radius-md);
    overflow: hidden;
}

.discarded-summary {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-4);
    cursor: pointer;
    color: var(--color-text-secondary);
    font-weight: var(--font-medium);
    transition: background-color var(--transition-base);
}

.discarded-summary:hover {
    background-color: rgba(255, 255, 255, 0.03);
}

.discarded-section[open] .discarded-summary .chevron-icon {
    transform: rotate(180deg);
}

.discarded-content {
    padding: 0 var(--space-4) var(--space-4);
}

.discarded-explainer {
    color: var(--color-text-tertiary);
    font-size: var(--text-sm);
    margin-bottom: var(--space-4);
    line-height: 1.5;
}

.discarded-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
}

.discarded-card {
    background: rgba(107, 114, 128, 0.1);
    border: 1px solid rgba(107, 114, 128, 0.2);
    border-radius: var(--radius-sm);
    overflow: hidden;
}

.discarded-card-summary {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-3);
    cursor: pointer;
    transition: background-color var(--transition-base);
}

.discarded-card-summary:hover {
    background-color: rgba(255, 255, 255, 0.02);
}

.discarded-card-summary .ingredient-name {
    font-weight: var(--font-medium);
    color: var(--color-text-secondary);
}

.discarded-card-summary .confounded-by {
    color: var(--color-text-tertiary);
}

.discarded-card-summary .arrow-icon {
    color: var(--color-text-tertiary);
}

.confidence-discarded {
    background-color: #6c757d;
    color: white;
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    margin-left: auto;
}

.discarded-card-body {
    padding: var(--space-3);
    border-top: 1px solid rgba(107, 114, 128, 0.2);
}

.original-analysis {
    margin-top: var(--space-3);
    background: rgba(0, 0, 0, 0.1);
    border-radius: var(--radius-sm);
}

.original-analysis-summary {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    cursor: pointer;
    color: var(--color-text-tertiary);
    font-size: var(--text-sm);
}

.original-analysis-summary:hover {
    color: var(--color-text-secondary);
}

.original-analysis-content {
    padding: var(--space-3);
    border-top: 1px solid rgba(255, 255, 255, 0.05);
}

.analysis-section {
    margin-bottom: var(--space-3);
}

.analysis-section:last-child {
    margin-bottom: 0;
}

.subsection-title {
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-1);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.analysis-list {
    list-style: disc;
    padding-left: var(--space-4);
    margin: 0;
    color: var(--color-text-tertiary);
    font-size: var(--text-sm);
}

.analysis-list li {
    margin-bottom: var(--space-1);
}

.symptoms-text {
    color: var(--color-text-tertiary);
    font-size: var(--text-sm);
    margin-top: var(--space-2);
}
</style>

{% endblock %}
